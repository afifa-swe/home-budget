import{d as B,r as k,a as I,b as D,c as $,o as C,e as y,u as O,f as S,w as M,g as j,h as P,i as r,j as l,k as Y,l as h,t as V,m as L,n as U}from"./index-0J9DSJ3W.js";const F=B("transactions",()=>{const n=k([]),u=k(""),s=k(!1);async function p(e){var c,i;s.value=!0;try{const o={};e?o.month=e:u.value&&(o.month=u.value);const f=await I.get("/transactions",{params:o});return n.value=Array.isArray(f.data)?f.data:((c=f.data)==null?void 0:c.data)??[],n.value=n.value.map(t=>({...t,category:typeof t.category=="object"?t.category:t.category?{id:t.category_id??null,name:t.category}:null})),(!n.value||n.value.length===0)&&console.log("fetchTransactions: empty result from API",f),f}catch(o){throw console.error("fetchTransactions error",((i=o==null?void 0:o.response)==null?void 0:i.data)??o.message),n.value=[],o}finally{s.value=!1}}async function _(e){const c={...e};c.category&&typeof c.category=="object"&&(c.category_id=c.category.id),delete c.category;const i=await I.post("/transactions",c),o={...i.data,category:i.data.category?{id:i.data.category_id??null,name:i.data.category}:null};return n.value.push(o),o}async function g(e,c){const i={...c};i.category&&typeof i.category=="object"&&(i.category_id=i.category.id),delete i.category;const o=await I.put(`/transactions/${e}`,i),f=n.value.findIndex(a=>a.id===e),t={...o.data,category:o.data.category?{id:o.data.category_id??null,name:o.data.category}:null};return f!==-1&&n.value.splice(f,1,t),t}async function v(e){await I.delete(`/transactions/${e}`);const c=n.value.findIndex(i=>i.id===e);c!==-1&&n.value.splice(c,1)}return{items:n,month:u,loading:s,fetchTransactions:p,createTransaction:_,updateTransaction:g,deleteTransaction:v}}),R=D({__name:"MonthPicker",setup(n){const u=F(),s=k("");function p(){u.fetchTransactions(s.value)}return(_,g)=>{const v=y("v-text-field");return C(),$(v,{type:"month",modelValue:s.value,"onUpdate:modelValue":g[0]||(g[0]=e=>s.value=e),label:"Месяц",onChange:p},null,8,["modelValue"])}}});function E(n){const u=typeof n=="string"?parseFloat(n):n;return new Intl.NumberFormat("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).format(u)}const q=D({__name:"TransactionForm",props:{editItem:{}},emits:["saved","cancel"],setup(n,{emit:u}){const s=n,p=u,_=F(),g=O(),v=()=>({type:"expense",category_id:null,occurred_at:"",amount:0,comment:""}),e=k(v()),c=S(()=>!!s.editItem);M(()=>s.editItem,t=>{t?e.value={type:t.type||"expense",category_id:t.category?t.category.id:t.category_id??null,occurred_at:t.occurred_at?t.occurred_at.slice(0,16):"",amount:t.amount??0,comment:t.comment??""}:e.value=v()},{immediate:!0});const i=S(()=>(g.items||[]).filter(a=>a.type===e.value.type));j(async()=>{try{await g.fetchCategories(),console.log("categories loaded",g.items)}catch(t){console.error("fetchCategories failed",t)}}),M(()=>e.value.type,()=>{e.value.category_id=null});async function o(){var t,a,b;try{if(!e.value.category_id){alert("Выберите категорию");return}c.value&&((t=s.editItem)!=null&&t.id)?await _.updateTransaction(s.editItem.id,{...e.value,occurred_at:e.value.occurred_at||new Date().toISOString()}):await _.createTransaction({...e.value,occurred_at:e.value.occurred_at||new Date().toISOString()}),await _.fetchTransactions(),p("saved"),e.value=v()}catch(d){alert(((b=(a=d==null?void 0:d.response)==null?void 0:a.data)==null?void 0:b.message)||d.message||"Ошибка сохранения")}}function f(){p("cancel"),e.value=v()}return(t,a)=>{const b=y("v-select"),d=y("v-col"),w=y("v-text-field"),m=y("v-btn"),T=y("v-textarea"),N=y("v-row"),A=y("v-form");return C(),$(A,{onSubmit:P(o,["prevent"])},{default:r(()=>[l(N,null,{default:r(()=>[l(d,{cols:"12",md:"3"},{default:r(()=>[l(b,{modelValue:e.value.type,"onUpdate:modelValue":a[0]||(a[0]=x=>e.value.type=x),items:["income","expense"],label:"Тип"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",md:"3"},{default:r(()=>[l(b,{modelValue:e.value.category_id,"onUpdate:modelValue":a[1]||(a[1]=x=>e.value.category_id=x),items:i.value,"item-title":"name","item-value":"id",label:"Категория"},null,8,["modelValue","items"])]),_:1}),l(d,{cols:"12",md:"3"},{default:r(()=>[l(w,{modelValue:e.value.occurred_at,"onUpdate:modelValue":a[2]||(a[2]=x=>e.value.occurred_at=x),type:"datetime-local",label:"Дата"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",md:"2"},{default:r(()=>[l(w,{modelValue:e.value.amount,"onUpdate:modelValue":a[3]||(a[3]=x=>e.value.amount=x),modelModifiers:{number:!0},type:"number",label:"Сумма"},null,8,["modelValue"])]),_:1}),l(d,{cols:"12",md:"1"},{default:r(()=>[l(m,{color:"primary",type:"submit"},{default:r(()=>[h(V(c.value?"Сохранить":"Добавить"),1)]),_:1}),c.value?(C(),$(m,{key:0,color:"grey",onClick:f,variant:"text"},{default:r(()=>[...a[5]||(a[5]=[h("Отмена",-1)])]),_:1})):Y("",!0)]),_:1}),l(d,{cols:"12"},{default:r(()=>[l(T,{modelValue:e.value.comment,"onUpdate:modelValue":a[4]||(a[4]=x=>e.value.comment=x),label:"Комментарий"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})}}}),z=D({__name:"TransactionTable",setup(n){const u=F(),s=S(()=>u.items),p=S(()=>u.loading),_=S(()=>[{title:"Тип",key:"type"},{title:"Категория",key:"category"},{title:"Дата",key:"occurred_at"},{title:"Сумма",key:"amount"},{title:"Итого",key:"running_balance"},{title:"Комментарий",key:"comment"},{title:"Действия",key:"actions",sortable:!1}]);function g(t){return t?t==="income"?"Доход":t==="expense"?"Расход":t:""}function v(t){if(!t)return"";const a=new Date(t),b=String(a.getDate()).padStart(2,"0"),d=String(a.getMonth()+1).padStart(2,"0"),w=a.getFullYear();return`${b}.${d}.${w}`}const e=k(null);function c(t){e.value={...t}}function i(){e.value=null}function o(){e.value=null}async function f(t){if(confirm("Удалить транзакцию?"))try{if(!t.id)throw new Error("Нет id");await u.deleteTransaction(t.id),await u.fetchTransactions()}catch{alert("Ошибка при удалении транзакции")}}return(t,a)=>{const b=y("v-icon"),d=y("v-btn"),w=y("v-data-table");return C(),L("div",null,[l(q,{editItem:e.value,onSaved:i,onCancel:o},null,8,["editItem"]),l(w,{style:{height:"700px"},items:s.value,headers:_.value,loading:p.value},{"item.occurred_at":r(({item:m})=>[h(V(v(m.occurred_at)),1)]),"item.type":r(({item:m})=>[h(V(g(m.type)),1)]),"item.category":r(({item:m})=>{var T;return[h(V(((T=m.category)==null?void 0:T.name)??""),1)]}),"item.amount":r(({item:m})=>[h(V(U(E)(m.amount??0)),1)]),"item.running_balance":r(({item:m})=>[h(V(U(E)(m.running_balance??0)),1)]),"item.actions":r(({item:m})=>[l(d,{icon:"",onClick:T=>c(m)},{default:r(()=>[l(b,null,{default:r(()=>[...a[0]||(a[0]=[h("mdi-pencil",-1)])]),_:1})]),_:1},8,["onClick"]),l(d,{icon:"",color:"red",onClick:T=>f(m)},{default:r(()=>[l(b,null,{default:r(()=>[...a[1]||(a[1]=[h("mdi-delete",-1)])]),_:1})]),_:1},8,["onClick"])]),_:1},8,["items","headers","loading"])])}}}),H=D({__name:"Transactions",setup(n){const u=F();return j(()=>{const s=u.month.value,p=s&&s.length?s:(()=>{const _=new Date;return`${_.getFullYear()}-${String(_.getMonth()+1).padStart(2,"0")}`})();u.fetchTransactions(p)}),(s,p)=>{const _=y("v-container");return C(),$(_,null,{default:r(()=>[l(R),l(z)]),_:1})}}});export{H as default};
